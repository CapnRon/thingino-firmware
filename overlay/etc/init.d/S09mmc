#!/bin/sh

MMC_SOC_FAMILY=$(ipcinfo -f)
MMC_SOC_SUBVAR=$(ipcinfo -c)

MMC_MODULE="jzmmc_v12"

MMC_GPIO_CD=$(fw_printenv -n gpio_mmc_cd)
# Default CD-PIN for Ingenic PB27 (GPIO59)
[ -z "$MMC_GPIO_CD" ] && MMC_GPIO_CD="59"

check_return() {
	if [ $? -ne 0 ]; then
		echo "err: $1"
		exit 1
	fi
}

start() {
	printf "Starting MMC: "

	MMC_PARAM="cd_gpio_pin=$MMC_GPIO_CD"

	# Check if MDIO directory exists
	if [ -d /proc/jz/mdio ]; then
		echo "/proc/jz/mdio directory exists!"
		exit 1
	else
		case "$MMC_SOC_FAMILY" in
			t20 | t10 | t21 | t30 | t40 | t41)
				# do nothing
				;;
			t31)
				# Check for specific SOC sub-variants
				if [ "$MMC_SOC_SUBVAR" = "t31a" ] || [ "$MMC_SOC_SUBVAR" = "t31al" ]; then
					echo "Skipping GPIO setup for $MMC_SOC_SUBVAR"
					return 1
				else
					ingenic-gpio pb08 func 1 drive 2
					ingenic-gpio pb09 func 1 drive 1
					ingenic-gpio pb10 func 1 drive 1
					ingenic-gpio pb11 func 1 drive 1
					ingenic-gpio pb13 func 1 drive 1
					ingenic-gpio pb14 func 1 drive 1
				fi
				;;
			t23)
				echo "Unsupported: T23"
				exit 1
				;;
			# Add more cases for other SOC types as needed here
			*)
				echo "Unsupported SOC type: $MMC_SOC_FAMILY"
				exit 1
				;;
		esac
	fi

	if grep -q "$MMC_MODULE" /proc/modules; then
		echo "$MMC_MODULE is already loaded"
		exit 1
	else
		echo modprobe $MMC_MODULE ${MMC_PARAM}
		if modprobe $MMC_MODULE ${MMC_PARAM}; then
			echo "OK"
		else
			echo "FAIL"
			exit 1
		fi
	fi
}

stop() {
	rmmod $MMC_MODULE
}

case "$1" in
	start | stop)
		$1
		;;
	reload | restart)
		stop
		sleep 1
		start
		;;
esac

exit 0
