
--- a/arch/mips/kernel/r4k_fpu.S
+++ b/arch/mips/kernel/r4k_fpu.S
@@ -22,6 +22,7 @@
 	.macro	EX insn, reg, src
 	.set	push
 	.set	nomacro
+	.set	hardfloat
 .ex\@:	\insn	\reg, \src
 	.set	pop
 	.section __ex_table,"a"
@@ -53,6 +54,36 @@ LEAF(_save_fp_context)
 	EX	sdc1 $f27, SC_FPREGS+216(a0)
 	EX	sdc1 $f29, SC_FPREGS+232(a0)
 	EX	sdc1 $f31, SC_FPREGS+248(a0)
+#else
+#ifdef CONFIG_MIPS32_R2
+	.set    push
+	.set    mips64r2
+	.set    noreorder
+	mfc0    t0, CP0_STATUS
+	sll     t0, t0, 31 - _ST0_FR
+	bgez    t0, 1f              # 16 / 32 register mode?
+	 nop
+
+	/* Store the 16 odd double precision registers */
+	EX      sdc1 $f1, SC_FPREGS+8(a0)
+	EX      sdc1 $f3, SC_FPREGS+24(a0)
+	EX      sdc1 $f5, SC_FPREGS+40(a0)
+	EX      sdc1 $f7, SC_FPREGS+56(a0)
+	EX      sdc1 $f9, SC_FPREGS+72(a0)
+	EX      sdc1 $f11, SC_FPREGS+88(a0)
+	EX      sdc1 $f13, SC_FPREGS+104(a0)
+	EX      sdc1 $f15, SC_FPREGS+120(a0)
+	EX      sdc1 $f17, SC_FPREGS+136(a0)
+	EX      sdc1 $f19, SC_FPREGS+152(a0)
+	EX      sdc1 $f21, SC_FPREGS+168(a0)
+	EX      sdc1 $f23, SC_FPREGS+184(a0)
+	EX      sdc1 $f25, SC_FPREGS+200(a0)
+	EX      sdc1 $f27, SC_FPREGS+216(a0)
+	EX      sdc1 $f29, SC_FPREGS+232(a0)
+	EX      sdc1 $f31, SC_FPREGS+248(a0)
+	.set    pop
+1:
+#endif
 #endif
 
 	/* Store the 16 even double precision registers */
@@ -82,6 +113,30 @@ LEAF(_save_fp_context)
 LEAF(_save_fp_context32)
 	cfc1	t1, fcr31
 
+	mfc0    t0, CP0_STATUS
+	sll     t0, t0, 31 - _ST0_FR
+	bgez    t0, 1f              # 16 / 32 register mode?
+	 nop
+
+	/* Store the 16 odd double precision registers */
+	EX      sdc1 $f1, SC_FPREGS+8(a0)
+	EX      sdc1 $f3, SC_FPREGS+24(a0)
+	EX      sdc1 $f5, SC_FPREGS+40(a0)
+	EX      sdc1 $f7, SC_FPREGS+56(a0)
+	EX      sdc1 $f9, SC_FPREGS+72(a0)
+	EX      sdc1 $f11, SC_FPREGS+88(a0)
+	EX      sdc1 $f13, SC_FPREGS+104(a0)
+	EX      sdc1 $f15, SC_FPREGS+120(a0)
+	EX      sdc1 $f17, SC_FPREGS+136(a0)
+	EX      sdc1 $f19, SC_FPREGS+152(a0)
+	EX      sdc1 $f21, SC_FPREGS+168(a0)
+	EX      sdc1 $f23, SC_FPREGS+184(a0)
+	EX      sdc1 $f25, SC_FPREGS+200(a0)
+	EX      sdc1 $f27, SC_FPREGS+216(a0)
+	EX      sdc1 $f29, SC_FPREGS+232(a0)
+	EX      sdc1 $f31, SC_FPREGS+248(a0)
+1:
+
 	EX	sdc1 $f0, SC32_FPREGS+0(a0)
 	EX	sdc1 $f2, SC32_FPREGS+16(a0)
 	EX	sdc1 $f4, SC32_FPREGS+32(a0)
@@ -131,6 +186,36 @@ LEAF(_restore_fp_context)
 	EX	ldc1 $f27, SC_FPREGS+216(a0)
 	EX	ldc1 $f29, SC_FPREGS+232(a0)
 	EX	ldc1 $f31, SC_FPREGS+248(a0)
+
+#else
+#ifdef CONFIG_MIPS32_R2
+	.set    push
+	.set    mips64r2
+	.set    noreorder
+	mfc0    t1, CP0_STATUS
+	sll     t1, t1, 31 - _ST0_FR
+	bgez    t1, 1f                          # 16 / 32 register mode?
+	 nop
+
+	EX      ldc1 $f1, SC_FPREGS+8(a0)
+	EX      ldc1 $f3, SC_FPREGS+24(a0)
+	EX      ldc1 $f5, SC_FPREGS+40(a0)
+	EX      ldc1 $f7, SC_FPREGS+56(a0)
+	EX      ldc1 $f9, SC_FPREGS+72(a0)
+	EX      ldc1 $f11, SC_FPREGS+88(a0)
+	EX      ldc1 $f13, SC_FPREGS+104(a0)
+	EX      ldc1 $f15, SC_FPREGS+120(a0)
+	EX      ldc1 $f17, SC_FPREGS+136(a0)
+	EX      ldc1 $f19, SC_FPREGS+152(a0)
+	EX      ldc1 $f21, SC_FPREGS+168(a0)
+	EX      ldc1 $f23, SC_FPREGS+184(a0)
+	EX      ldc1 $f25, SC_FPREGS+200(a0)
+	EX      ldc1 $f27, SC_FPREGS+216(a0)
+	EX      ldc1 $f29, SC_FPREGS+232(a0)
+	EX      ldc1 $f31, SC_FPREGS+248(a0)
+	.set    pop
+1:
+#endif
 #endif
 	EX	ldc1 $f0, SC_FPREGS+0(a0)
 	EX	ldc1 $f2, SC_FPREGS+16(a0)
@@ -155,9 +240,37 @@ LEAF(_restore_fp_context)
 
 #ifdef CONFIG_MIPS32_COMPAT
 LEAF(_restore_fp_context32)
+	.set    push
+	.set    mips64r2
+	.set    noreorder
+
 	/* Restore an o32 sigcontext.  */
 	EX	lw t0, SC32_FPC_CSR(a0)
-	EX	ldc1 $f0, SC32_FPREGS+0(a0)
+
+	mfc0    t1, CP0_STATUS
+	sll     t1, t1, 31 - _ST0_FR
+	bgez    t1, 1f                          # 16 / 32 register mode?
+	 nop
+
+	EX      ldc1 $f1, SC_FPREGS+8(a0)
+	EX      ldc1 $f3, SC_FPREGS+24(a0)
+	EX      ldc1 $f5, SC_FPREGS+40(a0)
+	EX      ldc1 $f7, SC_FPREGS+56(a0)
+	EX      ldc1 $f9, SC_FPREGS+72(a0)
+	EX      ldc1 $f11, SC_FPREGS+88(a0)
+	EX      ldc1 $f13, SC_FPREGS+104(a0)
+	EX      ldc1 $f15, SC_FPREGS+120(a0)
+	EX      ldc1 $f17, SC_FPREGS+136(a0)
+	EX      ldc1 $f19, SC_FPREGS+152(a0)
+	EX      ldc1 $f21, SC_FPREGS+168(a0)
+	EX      ldc1 $f23, SC_FPREGS+184(a0)
+	EX      ldc1 $f25, SC_FPREGS+200(a0)
+	EX      ldc1 $f27, SC_FPREGS+216(a0)
+	EX      ldc1 $f29, SC_FPREGS+232(a0)
+	EX      ldc1 $f31, SC_FPREGS+248(a0)
+1:
+
+	EX      ldc1 $f0, SC32_FPREGS+0(a0)
 	EX	ldc1 $f2, SC32_FPREGS+16(a0)
 	EX	ldc1 $f4, SC32_FPREGS+32(a0)
 	EX	ldc1 $f6, SC32_FPREGS+48(a0)
@@ -177,6 +290,7 @@ LEAF(_restore_fp_context32)
 	jr	ra
 	 li	v0, 0					# success
 	END(_restore_fp_context32)
+	.set    pop
 #endif
 
 	.set	reorder
